## DuckDB ASOF JOIN 用法介绍       
        
### 作者        
digoal        
        
### 日期        
2023-10-07        
        
### 标签        
PostgreSQL , DuckDB , asof join , 时序 , 不等关联    
        
----        
        
## 背景     
ASOF JOIN是duckdb 0.8新增的功能, 解决等值JOIN无法关联到数据, 使用非等值关联(`>,<,>=,>=`)又会关联到多条(需求只需要关联一条)到问题.  
  
实际的场景例如时序业务, 想根据相近或相等的时间戳进行数据关联.   
  
[《DuckDB 0.8.0 发布, 支持pivot语法, ASOF JOIN, 并行导入导出性能提升, 递归通配符解析文件, arrow 连接器等》](../202305/20230518_02.md)    
  
语法支持:  
```  
asof join  
asof inner join  
asof left join  
asof right join  
asof full join  
```  
  
例子:  
  
```  
create table t1(uid int, ts timestamp, info text);  
create table t2(uid int, ts timestamp, info text);  
  
insert into t1 select r, now()+(r||' second')::interval, md5(random()::text) from (select #1 as r from range(1,11)) t;   
insert into t2 select r, now()+(r||' second')::interval, md5(random()::text) from (select #1 as r from range(5,15)) t;   
insert into t2 select r, now()+(r||' second')::interval, md5(random()::text) from (select #1 as r from range(5,15)) t;   
```  
  
```  
D select * from t1;  
┌───────┬─────────────────────────┬──────────────────────────────────┐  
│  uid  │           ts            │               info               │  
│ int32 │        timestamp        │             varchar              │  
├───────┼─────────────────────────┼──────────────────────────────────┤  
│     1 │ 2023-10-07 08:19:18.993 │ 3cb56e9b90add18ef7ff45c1bda590f3 │  
│     2 │ 2023-10-07 08:19:19.993 │ 20607a6249c0114757fd332f7d142e73 │  
│     3 │ 2023-10-07 08:19:20.993 │ 0c374ee2cfc36e88f3ea03b39e5d57cd │  
│     4 │ 2023-10-07 08:19:21.993 │ af6cbff244d9042f0eb5fe8bf256ca5b │  
│     5 │ 2023-10-07 08:19:22.993 │ d939335a8964c7e9779914a68f54cd82 │  
│     6 │ 2023-10-07 08:19:23.993 │ e985b7663c7aff96b654fae605d37b57 │  
│     7 │ 2023-10-07 08:19:24.993 │ eeba5ea17962141c7066db3c45e82c83 │  
│     8 │ 2023-10-07 08:19:25.993 │ f67f30f52b54f5bb4b2efe497e5fa91b │  
│     9 │ 2023-10-07 08:19:26.993 │ ce6888aad76985287d58791f013b22be │  
│    10 │ 2023-10-07 08:19:27.993 │ 19aa2cd26c047bb03a94c5410726d503 │  
├───────┴─────────────────────────┴──────────────────────────────────┤  
│ 10 rows                                                  3 columns │  
└────────────────────────────────────────────────────────────────────┘  
D select * from t2;  
┌───────┬─────────────────────────┬──────────────────────────────────┐  
│  uid  │           ts            │               info               │  
│ int32 │        timestamp        │             varchar              │  
├───────┼─────────────────────────┼──────────────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.998 │ 19b464d6dfd9b58e440581ad90687ebf │  
│     6 │ 2023-10-07 08:19:23.998 │ a8d1c43ef37bcf1ee981c512d078b185 │  
│     7 │ 2023-10-07 08:19:24.998 │ 454a43801069eae17be85bf3d62ab560 │  
│     8 │ 2023-10-07 08:19:25.998 │ 4416076649376b28a637c4005321709d │  
│     9 │ 2023-10-07 08:19:26.998 │ 54e238255bfb5e9b4c0d59f68a7ed243 │  
│    10 │ 2023-10-07 08:19:27.998 │ 1c966c35914bd81513af0e19182f8766 │  
│    11 │ 2023-10-07 08:19:28.998 │ e0a43dea156995f06f27ff8bd66e2798 │  
│    12 │ 2023-10-07 08:19:29.998 │ 17095b26daeccf05defeb19118eb8359 │  
│    13 │ 2023-10-07 08:19:30.998 │ f5fdf7a82c5ea82b6d207d700e8f9a69 │  
│    14 │ 2023-10-07 08:19:31.998 │ df7c04cb4b9f767087f1c231a2a6316e │  
│     5 │ 2023-10-07 08:19:23.095 │ a5b51a7fa4109e21cc02dbca7edbc67a │  
│     6 │ 2023-10-07 08:19:24.095 │ 5c743d19a4068ac6f9c427194b5f7767 │  
│     7 │ 2023-10-07 08:19:25.095 │ 7c271a8a272be5bdabaca08197b4e54e │  
│     8 │ 2023-10-07 08:19:26.095 │ 4b5aa1f2bfaf45530f62f0da55654835 │  
│     9 │ 2023-10-07 08:19:27.095 │ f6ac5a69cb069936b43a272ea9968a71 │  
│    10 │ 2023-10-07 08:19:28.095 │ 0800efced5abd5abbabc490c8373bf79 │  
│    11 │ 2023-10-07 08:19:29.095 │ 1bf15ecb933387a240d021cb8d94c350 │  
│    12 │ 2023-10-07 08:19:30.095 │ c4966521a9ec9fdcb07d0d1bcdc7796b │  
│    13 │ 2023-10-07 08:19:31.095 │ 57622c843805dc0fde77d08049ec7eb3 │  
│    14 │ 2023-10-07 08:19:32.095 │ 651cc8a86849c006003a0ab1134fbdeb │  
├───────┴─────────────────────────┴──────────────────────────────────┤  
│ 20 rows                                                  3 columns │  
└────────────────────────────────────────────────────────────────────┘  
```  
  
```  
select t1.uid,t1.ts,t2.ts from t1 join t2 on t1.uid=t2.uid and t1.ts=t2.ts;  
  
┌───────┬───────────┬───────────┐  
│  uid  │    ts     │    ts     │  
│ int64 │ timestamp │ timestamp │  
├───────────────────────────────┤  
│            0 rows             │  
└───────────────────────────────┘  
  
select t1.uid,t1.ts,t2.ts from t1 asof join t2 on t1.uid=t2.uid and t1.ts >= t2.ts;  
┌───────┬───────────┬───────────┐  
│  uid  │    ts     │    ts     │  
│ int32 │ timestamp │ timestamp │  
├───────────────────────────────┤  
│            0 rows             │  
└───────────────────────────────┘  
  
select t1.uid,t1.ts,t2.ts from t1 asof join t2 on t1.uid=t2.uid and t1.ts <= t2.ts;  
  
┌───────┬─────────────────────────┬─────────────────────────┐  
│  uid  │           ts            │           ts            │  
│ int32 │        timestamp        │        timestamp        │  
├───────┼─────────────────────────┼─────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │  
└───────┴─────────────────────────┴─────────────────────────┘  
  
select t1.uid,t1.ts,t2.ts from t1 asof inner join t2 on t1.uid=t2.uid and t1.ts <= t2.ts;  
  
┌───────┬─────────────────────────┬─────────────────────────┐  
│  uid  │           ts            │           ts            │  
│ int32 │        timestamp        │        timestamp        │  
├───────┼─────────────────────────┼─────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │  
└───────┴─────────────────────────┴─────────────────────────┘  
  
select t1.uid,t1.ts,t2.ts from t1 asof left join t2 on t1.uid=t2.uid and t1.ts <= t2.ts;  
  
┌───────┬─────────────────────────┬─────────────────────────┐  
│  uid  │           ts            │           ts            │  
│ int32 │        timestamp        │        timestamp        │  
├───────┼─────────────────────────┼─────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │  
│     2 │ 2023-10-07 08:19:19.993 │                         │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │  
│     1 │ 2023-10-07 08:19:18.993 │                         │  
│     4 │ 2023-10-07 08:19:21.993 │                         │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │  
│     3 │ 2023-10-07 08:19:20.993 │                         │  
├───────┴─────────────────────────┴─────────────────────────┤  
│ 10 rows                                         3 columns │  
└───────────────────────────────────────────────────────────┘  
  
  
select t1.uid,t1.ts,t2.ts from t1 asof right join t2 on t1.uid=t2.uid and t1.ts <= t2.ts;  
  
  
┌───────┬─────────────────────────┬─────────────────────────┐  
│  uid  │           ts            │           ts            │  
│ int32 │        timestamp        │        timestamp        │  
├───────┼─────────────────────────┼─────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │  
│       │                         │ 2023-10-07 08:19:29.095 │  
│       │                         │ 2023-10-07 08:19:28.998 │  
│       │                         │ 2023-10-07 08:19:23.095 │  
│       │                         │ 2023-10-07 08:19:27.095 │  
│       │                         │ 2023-10-07 08:19:32.095 │  
│       │                         │ 2023-10-07 08:19:31.998 │  
│       │                         │ 2023-10-07 08:19:28.095 │  
│       │                         │ 2023-10-07 08:19:26.095 │  
│       │                         │ 2023-10-07 08:19:31.095 │  
│       │                         │ 2023-10-07 08:19:30.998 │  
│       │                         │ 2023-10-07 08:19:25.095 │  
│       │                         │ 2023-10-07 08:19:30.095 │  
│       │                         │ 2023-10-07 08:19:29.998 │  
│       │                         │ 2023-10-07 08:19:24.095 │  
├───────┴─────────────────────────┴─────────────────────────┤  
│ 20 rows                                         3 columns │  
└───────────────────────────────────────────────────────────┘  
  
  
select t1.uid,t1.ts,t2.ts from t1 asof full join t2 on t1.uid=t2.uid and t1.ts <= t2.ts;  
  
┌───────┬─────────────────────────┬─────────────────────────┐  
│  uid  │           ts            │           ts            │  
│ int32 │        timestamp        │        timestamp        │  
├───────┼─────────────────────────┼─────────────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │  
│     2 │ 2023-10-07 08:19:19.993 │                         │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │  
│     1 │ 2023-10-07 08:19:18.993 │                         │  
│     4 │ 2023-10-07 08:19:21.993 │                         │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │  
│     3 │ 2023-10-07 08:19:20.993 │                         │  
│       │                         │ 2023-10-07 08:19:29.095 │  
│       │                         │ 2023-10-07 08:19:28.998 │  
│       │                         │ 2023-10-07 08:19:23.095 │  
│       │                         │ 2023-10-07 08:19:27.095 │  
│       │                         │ 2023-10-07 08:19:32.095 │  
│       │                         │ 2023-10-07 08:19:31.998 │  
│       │                         │ 2023-10-07 08:19:28.095 │  
│       │                         │ 2023-10-07 08:19:26.095 │  
│       │                         │ 2023-10-07 08:19:31.095 │  
│       │                         │ 2023-10-07 08:19:30.998 │  
│       │                         │ 2023-10-07 08:19:25.095 │  
│       │                         │ 2023-10-07 08:19:30.095 │  
│       │                         │ 2023-10-07 08:19:29.998 │  
│       │                         │ 2023-10-07 08:19:24.095 │  
├───────┴─────────────────────────┴─────────────────────────┤  
│ 24 rows                                         3 columns │  
└───────────────────────────────────────────────────────────┘  
```  
  
asof还可以做差值限定来满足更多查询场景:    
```  
D select t1.uid,t1.ts,t2.ts,t2.ts-t1.ts from t1 asof join t2 on t1.uid=t2.uid and t1.ts <= t2.ts and t2.ts - t1.ts <= interval '4 ms';  
┌───────┬───────────┬───────────┬─────────────────┐  
│  uid  │    ts     │    ts     │ (t2.ts - t1.ts) │  
│ int32 │ timestamp │ timestamp │    interval     │  
├─────────────────────────────────────────────────┤  
│                     0 rows                      │  
└─────────────────────────────────────────────────┘  
D select t1.uid,t1.ts,t2.ts,t2.ts-t1.ts from t1 asof join t2 on t1.uid=t2.uid and t1.ts <= t2.ts and t2.ts - t1.ts <= interval '5 ms';  
┌───────┬─────────────────────────┬─────────────────────────┬─────────────────┐  
│  uid  │           ts            │           ts            │ (t2.ts - t1.ts) │  
│ int32 │        timestamp        │        timestamp        │    interval     │  
├───────┼─────────────────────────┼─────────────────────────┼─────────────────┤  
│     5 │ 2023-10-07 08:19:22.993 │ 2023-10-07 08:19:22.998 │ 00:00:00.005    │  
│     9 │ 2023-10-07 08:19:26.993 │ 2023-10-07 08:19:26.998 │ 00:00:00.005    │  
│    10 │ 2023-10-07 08:19:27.993 │ 2023-10-07 08:19:27.998 │ 00:00:00.005    │  
│     8 │ 2023-10-07 08:19:25.993 │ 2023-10-07 08:19:25.998 │ 00:00:00.005    │  
│     7 │ 2023-10-07 08:19:24.993 │ 2023-10-07 08:19:24.998 │ 00:00:00.005    │  
│     6 │ 2023-10-07 08:19:23.993 │ 2023-10-07 08:19:23.998 │ 00:00:00.005    │  
└───────┴─────────────────────────┴─────────────────────────┴─────────────────┘  
```  
  
  
使用asof join执行等值与`>=, >, <=, <`的匹配, 数据量再大也不用担心性能, 因为只匹配最接近的1条.    
  
性能数据可参考:  
- https://duckdb.org/2023/09/15/asof-joins-fuzzy-temporal-lookups.html   
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
