## MacOS PolarDB-X 数据库快速部署指南  
                        
### 作者                        
digoal                        
                        
### 日期                        
2022-08-10                       
                        
### 标签                        
PostgreSQL , PolarDB-X , MacOS    
                        
----                        
                        
## 背景        
参考文档:   
https://www.polardbx.com/document  
  
通过PXD快速部署PolarDB-X本地实例  
pxd是部署polardb-x的工具. 目前仅支持 x86 架构的机器. 依赖Python3 和 Docker.   
  
  
### 1.安装 Python3  
  
如果你的机器上已经安装了 python3，可以跳过  
  
检查命令：`which python3`，如果有返回则代表 `python3` 已安装  
  
推荐使用 Homebrew 安装 python3，如果没有 Homebrew，可参考 Homebrew 官方安装方法：  
  
```  
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"  
```  
  
使用Homebrew 安装 python3  
  
```  
brew install python  
```  
  
### 2. 安装 Docker Desktop for Mac  
参考文档：https://docs.docker.com/desktop/mac/install/  
  
Download Docker Desktop for Mac  
例如下载到了`~/Downloads`    
  
```  
cd ~/Downloads  
sudo hdiutil attach Docker.dmg  
sudo /Volumes/Docker/Docker.app/Contents/MacOS/install  
sudo hdiutil detach /Volumes/Docker  
```  
  
由于 Docker Desktop for Mac 的默认内存是 2G，无法满足 PolarDB-X 开发测试环境的最低要求， 需要在 Docker Preferences 中将内存调整到8G，如下图所示：  
  
注意: MacOS安装完Docker后一定要在application中打开并运行一下docker(运行后可以关掉), 才会在`/usr/local/bin`里面出现docker cli, 每次都要这么操作, 否则pxd获取image时会报错.   
  
  
### 3. 安装 PXD  
注意： 推荐使用 virtual environment 安装 PXD 工具. 后面的操作也需要都在虚拟环境中操作, 包括安装polardb-x, 启动, 连接docker等.    
  
```  
python3 -m venv venv  
source venv/bin/activate  
```  
  
安装前建议先执行如下命令升级 pip  
  
```  
pip install --upgrade pip  
```  
  
执行如下命令安装 pxd:  
  
```  
pip install pxd  
```  
  
注： 部分国内用户从 pypi 下载包的速度较慢, 可以使用如下命令从阿里云的镜像安装：  
  
```  
pip install -i https://mirrors.aliyun.com/pypi/simple/ pxd  
```  
  
### 4. 部署 PolarDB-X  
  
直接运行 pxd tryout 命令会创建一个最新版本的 PolarDB-X 数据库，其中 GMS, CN, DN, CDC 节点各 1 个：  
```  
pxd tryout  
```  
  
您也可以指定 CN，DN, CDC 节点的个数以及版本，命令如下：  
```  
pxd tryout -cn_replica 1 -cn_version latest -dn_replica 1 -dn_version latest -cdc_replica 1 -cdc_version latest  
```  
  
tryout 模式创建的 GMS 和 DN 默认采用单副本模式，如果您想创建基于 Paxos 的三副本的集群，使用如下命令：  
```  
pxd tryout -leader_only false  
```  
  
注意：三副本模式需要PXD版本为0.3.0及以上。  
  
下面是整个过程的记录:  
  
```  
pxd tryout  
...  
Processing  [#########---------------------------]   25%    create gms node  
Processing  [############------------------------]   33%    create gms db and tables  
Processing  [###############---------------------]   41%    create PolarDB-X root account  
Processing  [##################------------------]   50%    create dn  
Processing  [#####################---------------]   58%    register dn to gms  
Processing  [########################------------]   66%    create cn  
Processing  [###########################---------]   75%    wait cn ready  
Processing  [##############################------]   83%    create cdc containers  
Processing  [#################################---]   91%    wait PolarDB-X ready  
Processing  [####################################]  100%  
  
PolarDB-X cluster create successfully, you can try it out now.  
Connect PolarDB-X using the following command:  
  
    mysql -h127.0.0.1 -P3992 -upolardbx_root -pdbkudfhk  
```  
  
注意：PolarDB-X 管理员账号的密码随机生成，仅出现这一次，请注意保存。  
  
PolarDB-X 端口占用说明:    
  
目前本地测试模式，CN，DN，GMS 节点各会占用一个端口，该端口随机生成，如果因为端口冲突导致 PolarDB-X 创建失败，请执行 `pxd cleanup` 或者 `pxd delete {集群名}` 清理后重新创建即可。  
  
```  
(venv) IT-C02YW2EFLVDL:~ digoal$ pxd list  
/Users/digoal/venv/lib/python3.9/site-packages/deployer  
NAME                          CN        DN        CDC       STATUS           
pxc-tryout                    1         1         1         running   
```  
  
连接到polardb-x集群, mysql客户端在CN节点中有. 所以我们可以使用docker命令行来连接PolarDB-X.    
  
```  
(venv) IT-C02YW2EFLVDL:~ digoal$ docker ps -a  
CONTAINER ID   IMAGE                          COMMAND                  CREATED         STATUS         PORTS                      NAMES  
0ca5aa5c9f79   polardbx/galaxycdc:latest      "/bin/sh -c /home/ad…"   4 minutes ago   Up 4 minutes                              pxc-tryout-cdc-xxOD  
68f05f5a3a4e   polardbx/galaxysql:latest      "/home/admin/entrypo…"   4 minutes ago   Up 4 minutes   0.0.0.0:3992->3992/tcp     pxc-tryout-cn-BRjf  
e5eed057b92c   polardbx/galaxyengine:latest   "bash -c '/tools/xst…"   5 minutes ago   Up 5 minutes   0.0.0.0:15151->15151/tcp   pxc-tryout-dn-0-Cand-15151  
c4dabe87a6de   polardbx/galaxyengine:latest   "bash -c '/tools/xst…"   6 minutes ago   Up 6 minutes   0.0.0.0:17479->17479/tcp   pxc-tryout-gms-Cand-17479  
  
(venv) IT-C02YW2EFLVDL:~ digoal$ docker exec -it 68f05f5a3a4e mysql -h127.0.0.1 -P3992 -upolardbx_root -pdbkudfhk  
```  
  
```  
Welcome to the MariaDB monitor.  Commands end with ; or \g.  
Your MySQL connection id is 10  
Server version: 5.6.29 Tddl Server (ALIBABA)  
  
Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.  
  
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.  
  
MySQL [(none)]> select * from information_schema.schemata;  
+--------------+--------------------+----------------------------+------------------------+----------+--------------------+  
| CATALOG_NAME | SCHEMA_NAME        | DEFAULT_CHARACTER_SET_NAME | DEFAULT_COLLATION_NAME | SQL_PATH | DEFAULT_ENCRYPTION |  
+--------------+--------------------+----------------------------+------------------------+----------+--------------------+  
| def          | information_schema | utf8                       | UTF8_GENERAL_CI        | NULL     | NO                 |  
| def          | __cdc__            | utf8                       | UTF8_GENERAL_CI        | NULL     | NO                 |  
+--------------+--------------------+----------------------------+------------------------+----------+--------------------+  
2 rows in set (0.25 sec)  
  
MySQL [(none)]> create database polarx_example partition_mode='partitioning';  
Query OK, 1 row affected (0.38 sec)  
  
MySQL [(none)]> use polarx_example;  
Database changed  
MySQL [polarx_example]> create table example (  
    ->   `id` bigint(11) auto_increment NOT NULL,  
    ->   `name` varchar(255) DEFAULT NULL,  
    ->   `score` bigint(11) DEFAULT NULL,  
    ->   primary key (`id`)  
    -> ) engine=InnoDB default charset=utf8   
    -> partition by hash(id)   
    -> partitions 8;  
Query OK, 0 rows affected (1.13 sec)  
  
MySQL [polarx_example]> insert into example values(null,'lily',375),(null,'lisa',400),(null,'ljh',500);  
Query OK, 3 rows affected (0.06 sec)  
  
MySQL [polarx_example]> select * from example;  
+--------+------+-------+  
| id     | name | score |  
+--------+------+-------+  
| 100001 | lily |   375 |  
| 100002 | lisa |   400 |  
| 100003 | ljh  |   500 |  
+--------+------+-------+  
3 rows in set (0.10 sec)  
  
MySQL [polarx_example]> show topology from example;  
+----+-----------------------------+--------------------+----------------+  
| ID | GROUP_NAME                  | TABLE_NAME         | PARTITION_NAME |  
+----+-----------------------------+--------------------+----------------+  
|  0 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00000 | p1             |  
|  1 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00001 | p2             |  
|  2 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00002 | p3             |  
|  3 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00003 | p4             |  
|  4 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00004 | p5             |  
|  5 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00005 | p6             |  
|  6 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00006 | p7             |  
|  7 | POLARX_EXAMPLE_P00000_GROUP | example_AIex_00007 | p8             |  
+----+-----------------------------+--------------------+----------------+  
8 rows in set (0.01 sec)  
  
MySQL [polarx_example]> show master status ;  
+---------------+----------+--------------+------------------+-------------------+  
| FILE          | POSITION | BINLOG_DO_DB | BINLOG_IGNORE_DB | EXECUTED_GTID_SET |  
+---------------+----------+--------------+------------------+-------------------+  
| binlog.000001 |     8900 |              |                  |                   |  
+---------------+----------+--------------+------------------+-------------------+  
1 row in set (0.87 sec)  
  
MySQL [polarx_example]> show binlog events in 'binlog.000001' from 4;  
+---------------+------+-------------+------------+-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  
| LOG_NAME      | POS  | EVENT_TYPE  | SERVER_ID  | END_LOG_POS | INFO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  
+---------------+------+-------------+------------+-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  
| binlog.000001 |    4 | Format_desc | 2990132244 |         123 | Server ver: 5.6.29-PXC-5.4.13-20220621, Binlog ver: 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  
| binlog.000001 |  123 | Rows_query  | 2990132244 |         206 | CTS::696305156394215020814941167793901445120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  206 | Rows_query  | 2990132244 |         289 | CTS::696305156476842809614941167802248110080000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  289 | Rows_query  | 2990132244 |         372 | CTS::696305156560728889614941167810678661120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  372 | Rows_query  | 2990132244 |         455 | CTS::696305156650906425614941167819109212160000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  455 | Rows_query  | 2990132244 |         538 | CTS::696305156736050796814941167827455877120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  538 | Rows_query  | 2990132244 |         621 | CTS::696305168964963539214941169051269898240000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  621 | Rows_query  | 2990132244 |         704 | CTS::696305169049688480014941169059658506240000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  704 | Rows_query  | 2990132244 |         787 | CTS::696305169134832851214941169068089057280000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  787 | Rows_query  | 2990132244 |         870 | CTS::696305169220396652814941169076477665280000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  870 | Rows_query  | 2990132244 |         953 | CTS::696305169302605011214941169084866273280000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 |  953 | Rows_query  | 2990132244 |        1036 | CTS::696305181541164652814941170308680294400000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1036 | Rows_query  | 2990132244 |        1119 | CTS::696305181626728454414941170317068902400000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1119 | Rows_query  | 2990132244 |        1202 | CTS::696305181709356243214941170325499453440000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1202 | Rows_query  | 2990132244 |        1285 | CTS::696305181791564601614941170333846118400000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1285 | Rows_query  | 2990132244 |        1368 | CTS::696305181876289542414941170342234726400000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1368 | Rows_query  | 2990132244 |        1451 | CTS::696305194114429753614941171566090690560000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1451 | Rows_query  | 2990132244 |        1534 | CTS::696305194198735264014941171574437355520000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1534 | Rows_query  | 2990132244 |        1617 | CTS::696305194279685331214941171582867906560000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1617 | Rows_query  | 2990132244 |        1700 | CTS::696305194362732550414941171591298457600000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1700 | Rows_query  | 2990132244 |        1783 | CTS::696305194447457491214941171599603179520000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1783 | Rows_query  | 2990132244 |        1866 | CTS::696305206769903212814941172831889694730000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1866 | Rows_query  | 2990132244 |        1949 | CTS::696305206860080748814941172840320245760000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 1949 | Rows_query  | 2990132244 |        2032 | CTS::696305206941450246414941172848708853760000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2032 | Rows_query  | 2990132244 |        2115 | CTS::696305207026175187214941172857097461760000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2115 | Rows_query  | 2990132244 |        2198 | CTS::696305207104608672014941172865444126730000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2198 | Rows_query  | 2990132244 |        2281 | CTS::696305219347782048014941174089342033920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2281 | Rows_query  | 2990132244 |        2364 | CTS::696305219431248697614941174097772584960000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2364 | Rows_query  | 2990132244 |        2447 | CTS::696305219514295916814941174106119249920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2447 | Rows_query  | 2990132244 |        2530 | CTS::696305219597343136014941174114507857920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2530 | Rows_query  | 2990132244 |        2613 | CTS::696305219681229216014941174122854522890000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2613 | Rows_query  | 2990132244 |        2696 | CTS::696305231929016326414941175347591290880000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2696 | Rows_query  | 2990132244 |        2779 | CTS::696305232007449811214941175355854069770000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2779 | Rows_query  | 2990132244 |        2862 | CTS::696305232106015955214941175364284620800000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2862 | Rows_query  | 2990132244 |        2945 | CTS::696305232177319123214941175372673228800000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 2945 | Rows_query  | 2990132244 |        3028 | CTS::696305232262044064014941175381103779840000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3028 | Rows_query  | 2990132244 |        3111 | CTS::696305244500184275214941176604917800960000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3111 | Rows_query  | 2990132244 |        3194 | CTS::696305244587845228814941176613264465920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3194 | Rows_query  | 2990132244 |        3277 | CTS::696305244668795296014941176621611130890000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3277 | Rows_query  | 2990132244 |        3360 | CTS::696305244754778528014941176630083624970000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3360 | Rows_query  | 2990132244 |        3443 | CTS::696305244834050873614941176638430289920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3443 | Rows_query  | 2990132244 |        3526 | CTS::696305257072191084814941177862244311040000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3526 | Rows_query  | 2990132244 |        3609 | CTS::696305257159432608014941177870674862080000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3609 | Rows_query  | 2990132244 |        3692 | CTS::696305257241640966414941177879021527040000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3692 | Rows_query  | 2990132244 |        3775 | CTS::696305257328043628814941177887452078080000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3775 | Rows_query  | 2990132244 |        3858 | CTS::696305257412768569614941177895882629120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3858 | Rows_query  | 2990132244 |        3941 | CTS::696305269646714476814941179119570821120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 3941 | Rows_query  | 2990132244 |        4024 | CTS::696305269736053152014941179127959429130000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4024 | Rows_query  | 2990132244 |        4107 | CTS::696305269816164358414941179136348037120000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4107 | Rows_query  | 2990132244 |        4190 | CTS::696305269899631008014941179144778588160000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4190 | Rows_query  | 2990132244 |        4273 | CTS::696305269984355948814941179153167196160000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4273 | Rows_query  | 2990132244 |        4356 | CTS::696305282220399008014941180377023160320000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4356 | Rows_query  | 2990132244 |        4439 | CTS::696305282307640531214941180385411768320000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4439 | Rows_query  | 2990132244 |        4522 | CTS::696305282386074016014941180393758433280000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4522 | Rows_query  | 2990132244 |        4605 | CTS::696305282469960096014941180402147041280000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4605 | Rows_query  | 2990132244 |        4688 | CTS::696305282558459910414941180410577592320000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4688 | Rows_query  | 2990132244 |        4771 | CTS::696305294791986387214941181634265784330000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4771 | Rows_query  | 2990132244 |        4854 | CTS::696305294882163923214941181642654392330000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4854 | Rows_query  | 2990132244 |        4937 | CTS::696305294963533420814941181651126886400000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 4937 | Rows_query  | 2990132244 |        5020 | CTS::696305295053291526414941181659431608330000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5020 | Rows_query  | 2990132244 |        5103 | CTS::696305295150179948814941181667862159360000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5103 | Rows_query  | 2990132244 |        5186 | CTS::696305307371962374414941182891802009600000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5186 | Rows_query  | 2990132244 |        5269 | CTS::696305307456687315214941182900106731520000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5269 | Rows_query  | 2990132244 |        5352 | CTS::696305307535120800014941182908453396490000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5352 | Rows_query  | 2990132244 |        5435 | CTS::696305307619426310414941182916925890570000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5435 | Rows_query  | 2990132244 |        5518 | CTS::696305307703312390414941182925272555520000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5518 | Rows_query  | 2990132244 |        5601 | CTS::696305319940613740814941184149086576650000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5601 | Rows_query  | 2990132244 |        5684 | CTS::696305320025758112014941184157517127680000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5684 | Rows_query  | 2990132244 |        5767 | CTS::696305320111741344014941184165905735680000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5767 | Rows_query  | 2990132244 |        5850 | CTS::696305320192691411214941184174252400650000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5850 | Rows_query  | 2990132244 |        5933 | CTS::696305320278255212814941184182724894720000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 5933 | Rows_query  | 2990132244 |        6016 | CTS::696305332599862073614941185414885580800000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 6016 | Rows_query  | 2990132244 |        6099 | CTS::696305332682489862414941185423274188810000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 6099 | Rows_query  | 2990132244 |        6182 | CTS::696305332778119993614941185431704739840000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 6182 | Rows_query  | 2990132244 |        6265 | CTS::696305332849423161614941185440051404800000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 6265 | Query       | 2990132244 |        6558 | # POLARX_ORIGIN_SQL=CREATE DATABASE polarx_example MODE 'partitioning'  
# POLARX_TSO=696305338377515833614941185991141007360000000000000000  
CREATE DATABASE polarx_example CHARACTER SET utf8mb4                                                                                                                                                                                                                                                                                                                                                                                          |  
| binlog.000001 | 6558 | Rows_query  | 2990132244 |        6641 | CTS::696305338377515833614941185991141007360000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 6641 | Query       | 2990132244 |        7311 | # POLARX_ORIGIN_SQL=CREATE TABLE example ( `id` bigint(11) NOT NULL AUTO_INCREMENT, `name` varchar(255) DEFAULT NULL, `score` bigint(11) DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE = InnoDB DEFAULT CHARSET = utf8 PARTITION BY HASH (id) PARTITIONS 8  
# POLARX_TSO=696305344376628844814941186592688087040000000000000000  
create table example ( `id` bigint(11) not null auto_increment, `name` varchar(255) default null, `score` bigint(11) default null, primary key (`id`) ) engine = innodb default charset = utf8 default character set = utf8 default collate = utf8_general_ci |  
| binlog.000001 | 7311 | Rows_query  | 2990132244 |        7394 | CTS::696305344376628844814941186592688087040000000000000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7394 | Rows_query  | 2990132244 |        7477 | CTS::696305345174804896014941186672254033920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7477 | Rows_query  | 2990132244 |        7560 | CTS::696305345260368697614941186680642641920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7560 | Rows_query  | 2990132244 |        7643 | CTS::696305345340060473614941186688989306880000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7643 | Rows_query  | 2990132244 |        7726 | CTS::696305345428560288014941186697419857920000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7726 | Rows_query  | 2990132244 |        7809 | CTS::696305345511188076814941186705850408960000000000469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 7809 | Query       | 2990132244 |        7872 | BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  
| binlog.000001 | 7872 | Rows_query  | 2990132244 |        7937 | /*DRDS /127.0.0.1/14bc2d04ff401000/1// */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  
| binlog.000001 | 7937 | Table_map   | 2990132244 |        8001 | table_id: 1 (polarx_example.example)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  
| binlog.000001 | 8001 | Write_rows  | 2990132244 |        8059 | table_id: 1 flags: STMT_END_F                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  
| binlog.000001 | 8059 | Xid         | 2990132244 |        8090 | COMMIT /* xid=1 */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  
| binlog.000001 | 8090 | Rows_query  | 2990132244 |        8173 | CTS::696305346014085126414941186756140113920000000001469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 8173 | Query       | 2990132244 |        8236 | BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  
| binlog.000001 | 8236 | Rows_query  | 2990132244 |        8301 | /*DRDS /127.0.0.1/14bc2d04ff401000/1// */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  
| binlog.000001 | 8301 | Table_map   | 2990132244 |        8365 | table_id: 1 (polarx_example.example)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  
| binlog.000001 | 8365 | Write_rows  | 2990132244 |        8423 | table_id: 1 flags: STMT_END_F                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  
| binlog.000001 | 8423 | Xid         | 2990132244 |        8454 | COMMIT /* xid=2 */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  
| binlog.000001 | 8454 | Rows_query  | 2990132244 |        8537 | CTS::696305346014085126414941186756140113920000000002469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
| binlog.000001 | 8537 | Query       | 2990132244 |        8600 | BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |  
| binlog.000001 | 8600 | Rows_query  | 2990132244 |        8665 | /*DRDS /127.0.0.1/14bc2d04ff401000/1// */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |  
| binlog.000001 | 8665 | Table_map   | 2990132244 |        8729 | table_id: 1 (polarx_example.example)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |  
| binlog.000001 | 8729 | Write_rows  | 2990132244 |        8786 | table_id: 1 flags: STMT_END_F                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |  
| binlog.000001 | 8786 | Xid         | 2990132244 |        8817 | COMMIT /* xid=3 */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |  
| binlog.000001 | 8817 | Rows_query  | 2990132244 |        8900 | CTS::696305346014085126414941186756140113920000000003469718                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |  
+---------------+------+-------------+------------+-------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+  
102 rows in set (0.44 sec)  
  
MySQL [polarx_example]> show storage ;    
+-----------------+------------------+------------+-----------+----------+-------------+--------+-----------+-------+--------+  
| STORAGE_INST_ID | LEADER_NODE      | IS_HEALTHY | INST_KIND | DB_COUNT | GROUP_COUNT | STATUS | DELETABLE | DELAY | ACTIVE |  
+-----------------+------------------+------------+-----------+----------+-------------+--------+-----------+-------+--------+  
| pxc-tryout-dn-0 | 172.17.0.3:15151 | true       | MASTER    | 2        | 3           | 0      | false     | null  | null   |  
| pxc-tryout-gms  | 172.17.0.2:17479 | true       | META_DB   | 2        | 2           | 0      | false     | null  | null   |  
+-----------------+------------------+------------+-----------+----------+-------------+--------+-----------+-------+--------+  
2 rows in set (0.01 sec)  
  
MySQL [polarx_example]> show mpp ;  
+------------+-----------------+------+--------+  
| ID         | NODE            | ROLE | LEADER |  
+------------+-----------------+------+--------+  
| pxc-tryout | 172.17.0.4:3994 | W    | Y      |  
+------------+-----------------+------+--------+  
1 row in set (0.00 sec)  
```  
  
使用说明:    
  
```  
# 检查GMS   
select * from information_schema.schemata;  
  
# 创建分区表  
create database polarx_example partition_mode='partitioning';  
  
use polarx_example;  
  
create table example (  
  `id` bigint(11) auto_increment NOT NULL,  
  `name` varchar(255) DEFAULT NULL,  
  `score` bigint(11) DEFAULT NULL,  
  primary key (`id`)  
) engine=InnoDB default charset=utf8   
partition by hash(id)   
partitions 8;  
  
insert into example values(null,'lily',375),(null,'lisa',400),(null,'ljh',500);  
  
select * from example;  
  
show topology from example;  
  
# 检查CDC  
show master status ;  
show binlog events in 'binlog.000001' from 4;  
  
  
# 检查DN和CN  
show storage ;    
show mpp ;  
```  
  
### 5. 查看 PolarDB-X 状态  
  
执行如下命令，查看当前环境的 PolarDB-X 列表：  
```  
pxd list  
```  
  
### 6. 清理 PolarDB-X  
  
执行如下命令，即可清理本地环境所有的 PolarDB-X：  
```  
pxd cleanup  
```  
  
执行如下命令可以查看 pxd 的更多指令及用法：  

```
pxd --help
```
  
### 7. 其他操作
使用docker连接到容器, 可以查看对应服务的日志.   
  
```
(venv) IT-C02YW2EFLVDL:~ digoal$ docker exec -it 53ef61b59653 bash
[admin@53ef61b59653 ~]$ 
[admin@53ef61b59653 ~]$ ls
bin  drds-server  entrypoint.sh  tools
[admin@53ef61b59653 ~]$ cd drds-server/
[admin@53ef61b59653 drds-server]$ ls
bin  conf  lib  logs  spill
[admin@53ef61b59653 drds-server]$ cd logs
[admin@53ef61b59653 logs]$ ls
__cdc__  polardbx  tddl
[admin@53ef61b59653 logs]$ cd tddl
[admin@53ef61b59653 tddl]$ ls
check-ha.log  ddl-meta.log   event.log  gc.log.0  gc.log.2  gc.log.4     rpc.log       tddl-console.log  tddl-executor.log  tddl-sequence.log  trans.log  XPerf.log
ddl.log       ddl-stats.log  gc.log     gc.log.1  gc.log.3  meta-db.log  start-up.log  tddl-dynamic.log  tddl.log           tddl-stat.log      XLog.log   XRequest.log
```
  
也可以使用配置文件部署polardb-x  

```  
vi ~/px.yaml  
  
  
version: v1  
type: polardbx  
cluster:  
  name: pxc_test  
  gms:  
    image: polardbx/galaxyengine:latest  
    host_group: [127.0.0.1]  
  cn:  
    image: polardbx/galaxysql:latest  
    replica: 1  
    nodes:  
      - host: 127.0.0.1  
    resources:  
      mem_limit: 2G  
  dn:  
    image: polardbx/galaxyengine:latest  
    replica: 1  
    nodes:  
      - host_group: [127.0.0.1]  
    resources:  
      mem_limit: 2G  
  cdc:  
    image: polardbx/galaxycdc:latest  
    replica: 1  
    nodes:  
      - host: 127.0.0.1  
    resources:  
      mem_limit: 2G  
```  
  
```  
pxd cleanup  
pxd create -file ~/px.yaml  
```  
  
  
  
  
停止容器  
```  
docker stop 70a7c08f943a e39532b652bc 9cad34440635 572f97117552  
```  
  
启动容器, 按创建的相反顺序: dsm,dn,cn,cdc.   而且本地容器IP会变化, 按顺序可以保证IP不变.    
```  
(venv) IT-C02YW2EFLVDL:~ digoal$ docker ps -a
CONTAINER ID   IMAGE                          COMMAND                  CREATED              STATUS              PORTS                      NAMES
8de91f7d2adc   polardbx/galaxycdc:latest      "/bin/sh -c /home/ad…"   4 seconds ago        Up 3 seconds                                   pxc_test-cdc-lboQ
3e606d60db97   polardbx/galaxysql:latest      "/home/admin/entrypo…"   4 seconds ago        Up 3 seconds        0.0.0.0:5425->5425/tcp     pxc_test-cn-Fach
51c4fe463fa2   polardbx/galaxyengine:latest   "bash -c '/tools/xst…"   47 seconds ago       Up 46 seconds       0.0.0.0:15321->15321/tcp   pxc_test-dn-0-Cand-15321
af6766bcc723   polardbx/galaxyengine:latest   "bash -c '/tools/xst…"   About a minute ago   Up About a minute   0.0.0.0:14376->14376/tcp   pxc_test-gms-Cand-14376



(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect af6766bcc723|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.2",
                    "IPAddress": "172.17.0.2",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 51c4fe463fa2|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.3",
                    "IPAddress": "172.17.0.3",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 3e606d60db97|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.4",
                    "IPAddress": "172.17.0.4",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 8de91f7d2adc|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.5",
                    "IPAddress": "172.17.0.5",



docker start af6766bcc723
docker start 51c4fe463fa2
docker start 3e606d60db97
docker start 8de91f7d2adc

启动后再检查一下, IP是否和创建时一致.


(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect af6766bcc723|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.2",
                    "IPAddress": "172.17.0.2",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 51c4fe463fa2|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.3",
                    "IPAddress": "172.17.0.3",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 3e606d60db97|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.4",
                    "IPAddress": "172.17.0.4",
(venv) IT-C02YW2EFLVDL:~ digoal$ docker inspect 8de91f7d2adc|grep IPAddre
            "SecondaryIPAddresses": null,
            "IPAddress": "172.17.0.5",
                    "IPAddress": "172.17.0.5",
```  
  
查看容器配置  
```  
docker inspect e39532b652bc  
```  
  
进入容器命令行环境  
```  
docker exec -it e39532b652bc bash  
```  
  
查看容器运行日志  
```  
docker logs -t --since 30m e39532b652bc  
```  
  
```  
命令格式：  
  
$ docker logs [OPTIONS] CONTAINER  
  Options:  
        --details        显示更多的信息  
    -f, --follow         跟踪实时日志  
        --since string   显示自某个timestamp之后的日志，或相对时间，如42m（即42分钟）  
        --tail string    从日志末尾显示多少行日志， 默认是all  
    -t, --timestamps     显示时间戳  
        --until string   显示自某个timestamp之前的日志，或相对时间，如42m（即42分钟）  
  
例子：  
  
查看指定时间后的日志，只显示最后100行：  
  
$ docker logs -f -t --since="2018-02-08" --tail=100 CONTAINER_ID  
  
查看最近30分钟的日志:  
  
$ docker logs --since 30m CONTAINER_ID  
  
查看某时间之后的日志：  
  
$ docker logs -t --since="2018-02-08T13:23:37" CONTAINER_ID  
  
查看某时间段日志：  
  
$ docker logs -t --since="2018-02-08T13:23:37" --until "2018-02-09T12:23:37" CONTAINER_ID  
```  
  
  
  
  
  
#### [期望 PostgreSQL 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB for PostgreSQL云原生分布式开源数据库](https://github.com/ApsaraDB/PolarDB-for-PostgreSQL "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
