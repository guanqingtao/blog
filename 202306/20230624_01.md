## 使用DuckDB分析高中生联考成绩excel(xlst)数据, 文理选课分析           
                                                                                      
### 作者                                                                                      
digoal                                                                                      
                                                                                      
### 日期                                                                                      
2022-06-24                                                                           
                                                                                      
### 标签                                                                                      
PostgreSQL , PolarDB , duckdb                                                                   
                                                                                      
----                                                                        
                                                                                      
## 背景      
高中生家长经常要看学校发的联考数据, 通过数据分析高二开始选什么副科.  联考数据量较大, 参考人数几万, 用excel分析有点吃力. 正好duckdb支持了excel读写能力, 可以导入到duckdb进行分析.   
  
当然了posgresql和polardb for postgresql 通过`gdal/ogr`插件也可以访问`excel`的数据.    
- https://wiki.postgresql.org/wiki/Foreign_data_wrappers    
- https://github.com/pramsey/pgsql-ogr-fdw    
    
## 例子  
下面演示duckdb读取xlst.  
  
https://duckdb.org/docs/guides/import/excel_import  
  
环境:  
- [《老机器上安装ubuntu 11, 使用lvm, 测试postgresql 16 & duckdb 0.8.1》](../202306/20230622_01.md)    
  
1、加载spatial插件, 这个插件使用GDAL库解析xlsx内容.    
    
```  
D install spatial;   
D load spatial;   
D .mode line  
```  
  
查看st_read函数定义  
  
```  
D select * from duckdb_functions() where function_name like '%st_read%';  
   database_name = system  
     schema_name = main  
   function_name = st_read  
   function_type = table  
     description =   
     return_type =   
      parameters = [col0, max_batch_size, sequential_layer_scan, layer, sibling_files, spatial_filter, spatial_filter_box, allowed_drivers, open_options]  
 parameter_types = [VARCHAR, INTEGER, BOOLEAN, VARCHAR, VARCHAR[], WKB_BLOB, BOX_2D, VARCHAR[], VARCHAR[]]  
         varargs =   
macro_definition =   
has_side_effects =   
        internal = true  
    function_oid = 1473  
         example =   
```  
  
查询xlst的方法比较简单, 如下:  
  
```  
D .mode duckbox  
D .maxrows 100  
D .maxwidth -1  
  
D SELECT * FROM st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1') limit 10;  
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬────────┬──────────┬──────────┬──────────┬──────────┬──────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│  姓名   │ 准考证号 │ 自定义考号 │  班级   │        学校        │  总分  │ 总分排名 │ 侧理总分 │ 侧理排名 │ 侧文总分 │ 侧文排名 │  语文  │  数学  │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ double │  int32   │  double  │  int32   │  double  │  int32   │ double │ double │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼────────┼──────────┼──────────┼──────────┼──────────┼──────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  937.5 │        1 │    575.0 │       19 │    547.5 │       25 │  108.0 │  137.5 │  132.5 │   98.0 │   99.0 │   99.0 │   84.0 │   85.5 │   94.0 │  
│ xxx    │ xxx │ xxx │ 9班     │ 杭州市余杭高级中学 │  934.5 │        2 │    587.5 │        1 │    568.5 │        2 │  111.0 │  144.0 │  138.5 │   98.0 │   96.0 │   99.0 │   85.0 │   90.0 │   73.0 │  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  929.5 │        3 │    572.5 │       28 │    547.0 │       26 │  113.0 │  123.5 │  138.5 │   98.0 │   99.5 │  100.0 │   86.0 │   86.0 │   85.0 │  
│ xxx  │ xxx │ xxx │ 2501班  │ 浙江省萧山中学     │  928.5 │        4 │    580.5 │        7 │    561.0 │        5 │  118.0 │  135.5 │  139.5 │   97.0 │   90.5 │  100.0 │   83.0 │   85.0 │   80.0 │  
│ xxx  │ xxx │ xxx │ 2505班  │ 浙江省萧山中学     │  926.0 │        5 │    572.5 │       28 │    545.0 │       31 │  109.0 │  132.0 │  136.5 │   96.0 │   99.0 │   94.0 │   89.0 │   78.5 │   92.0 │  
│ xxx  │ xxx │ xxx │ 2502班  │ 浙江省萧山中学     │  925.5 │        6 │    571.5 │       32 │    551.0 │       16 │  111.0 │  134.0 │  132.0 │   94.5 │  100.0 │   94.0 │   85.5 │   88.5 │   86.0 │  
│ xxx  │ xxx │ xxx │ 1班     │ 桐庐中学           │  923.0 │        7 │    573.0 │       25 │    562.0 │        4 │  113.0 │  144.0 │  124.0 │   99.0 │   93.0 │   93.0 │   89.0 │   92.0 │   76.0 │  
│ xxx  │ xxx │ xxx │ 5班     │ 杭州市余杭高级中学 │ 922.25 │        8 │    574.5 │       21 │   551.25 │       15 │  107.0 │  135.0 │  138.0 │   97.5 │   97.0 │   97.5 │  83.75 │   87.5 │   79.0 │  
│ xxx  │ xxx │ xxx │ 12班    │ 杭州市余杭高级中学 │ 922.25 │        8 │    564.5 │       60 │   571.25 │        1 │  115.0 │  138.0 │  140.5 │   80.0 │   91.0 │   92.0 │  90.75 │   87.0 │   88.0 │  
│ xxx  │ xxx │ xxx │ 2505班  │ 浙江省萧山中学     │ 922.25 │        8 │    562.5 │       74 │   542.25 │       48 │  109.5 │  126.5 │  130.0 │   98.0 │   98.5 │   96.5 │  85.75 │   90.5 │   87.0 │  
├─────────┴──────────┴────────────┴─────────┴────────────────────┴────────┴──────────┴──────────┴──────────┴──────────┴──────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 10 rows                                                                                                                                                                                              20 columns │  
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
```  
D .maxwidth 0  
D SELECT * FROM st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1') limit 10;  
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬────────┬──────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│  姓名   │ 准考证号 │ 自定义考号 │  班级   │        学校        │  总分  │ 总分排名 │ … │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ double │  int32   │   │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼────────┼──────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│ xxx  │ xxx   |   xxx  │ 2502班  │ 浙江省萧山中学     │  937.5 │        1 │ … │  132.5 │   98.0 │   99.0 │   99.0 │   84.0 │   85.5 │   94.0 │  
│ xxx  │ xxx   |   xxx  │ 9班     │ 杭州市余杭高级中学 │  934.5 │        2 │ … │  138.5 │   98.0 │   96.0 │   99.0 │   85.0 │   90.0 │   73.0 │  
│ xxx  │ xxx   |   xxx  │ 2502班  │ 浙江省萧山中学     │  929.5 │        3 │ … │  138.5 │   98.0 │   99.5 │  100.0 │   86.0 │   86.0 │   85.0 │  
│ xxx  │ xxx   |   xxx  │ 2501班  │ 浙江省萧山中学     │  928.5 │        4 │ … │  139.5 │   97.0 │   90.5 │  100.0 │   83.0 │   85.0 │   80.0 │  
│ xxx  │ xxx   |   xxx  │ 2505班  │ 浙江省萧山中学     │  926.0 │        5 │ … │  136.5 │   96.0 │   99.0 │   94.0 │   89.0 │   78.5 │   92.0 │  
│ xxx  │ xxx   |   xxx  │ 2502班  │ 浙江省萧山中学     │  925.5 │        6 │ … │  132.0 │   94.5 │  100.0 │   94.0 │   85.5 │   88.5 │   86.0 │  
│ xxx  │ xxx   |   xxx  │ 1班     │ 桐庐中学           │  923.0 │        7 │ … │  124.0 │   99.0 │   93.0 │   93.0 │   89.0 │   92.0 │   76.0 │  
│ xxx  │ xxx   |   xxx  │ 5班     │ 杭州市余杭高级中学 │ 922.25 │        8 │ … │  138.0 │   97.5 │   97.0 │   97.5 │  83.75 │   87.5 │   79.0 │  
│ xxx  │ xxx   |   xxx  │ 12班    │ 杭州市余杭高级中学 │ 922.25 │        8 │ … │  140.5 │   80.0 │   91.0 │   92.0 │  90.75 │   87.0 │   88.0 │  
│ xxx  │ xxx   |   xxx  │ 2505班  │ 浙江省萧山中学     │ 922.25 │        8 │ … │  130.0 │   98.0 │   98.5 │   96.5 │  85.75 │   90.5 │   87.0 │  
├─────────┴──────────┴────────────┴─────────┴────────────────────┴────────┴──────────┴───┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 10 rows                                                                                                                         20 columns (14 shown) │  
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
2、下面是一些分析过程  
  
我们的情况是高一大多数的时间放在主科和理科, 考试前补一补文科. 虽然投入时间偏理, 文理和总成绩排名几乎差不多.    
  
```  
select * from (  
  select   
    row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) desc nulls last) as wen_rn,   
    row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) desc nulls last) as li_rn,   
    "总分排名",   
    coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) as wen,  
    coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) as li,  
    COLUMNS(* EXCLUDE ("总分排名", "准考证号", "自定义考号")) from st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1')   
) t  
where "姓名"='xxx';  
  
  
┌────────┬───────┬──────────┬────────┬────────┬─────────┬─────────┬──────────────────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│ wen_rn │ li_rn │ 总分排名 │  wen   │   li   │  姓名   │  班级   │         学校         │ … │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ int64  │ int64 │  int32   │ double │ double │ varchar │ varchar │       varchar        │   │ double │ double │ double │ double │ double │ double │ double │  
├────────┼───────┼──────────┼────────┼────────┼─────────┼─────────┼──────────────────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│   1948 │  1917 │     1700 │  537.0 │  565.0 │ xxx  │ 14班       │ 杭州市余杭中学       │ … │  105.5 │   81.0 │   87.0 │   78.0 │   78.5 │   63.5 │   76.0 │  
```  
  
  
3、按纯文和纯理的选课, 得到纯文纯理的排名如下:   
  
```  
select * from (  
  select   
    row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) desc nulls last) as wen_rn,   
    row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) desc nulls last) as li_rn,   
    "总分排名",   
    coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) as wen,  
    coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) as li,  
    COLUMNS(* EXCLUDE ("总分排名", "准考证号", "自定义考号")) from st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1')   
) t  
where "学校"='杭州市余杭中学' order by "总分排名" limit 20;   
  
  
  
┌────────┬───────┬──────────┬────────┬────────┬──────────┬─────────┬────────────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│ wen_rn │ li_rn │ 总分排名 │  wen   │   li   │   姓名   │  班级   │      学校      │ … │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ int64  │ int64 │  int32   │ double │ double │ varchar  │ varchar │    varchar     │   │ double │ double │ double │ double │ double │ double │ double │  
├────────┼───────┼──────────┼────────┼────────┼──────────┼─────────┼────────────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│    698 │   944 │      814 │  570.5 │  595.0 │          │ 13班    │ 杭州市余杭中学 │ … │  127.5 │   75.5 │   87.5 │   88.0 │   79.0 │   74.5 │   73.0 │  
│    966 │  1303 │      969 │  561.0 │  582.0 │          │ 14班    │ 杭州市余杭中学 │ … │  108.5 │   84.0 │   87.0 │   81.0 │   77.0 │   85.0 │   69.0 │  
│   1155 │  2755 │     1190 │  555.0 │  547.0 │          │ 11班    │ 杭州市余杭中学 │ … │  119.0 │   76.5 │   90.0 │   81.5 │   86.0 │   85.0 │   85.0 │  
│   1994 │  2050 │     1417 │  536.0 │  562.0 │          │ 11班    │ 杭州市余杭中学 │ … │   97.5 │   76.0 │   89.5 │   91.5 │   73.0 │   80.0 │   78.0 │  
│   1899 │  1339 │     1424 │  538.0 │  581.0 │          │ 11班    │ 杭州市余杭中学 │ … │  117.5 │   77.5 │   90.0 │   87.0 │   72.5 │   73.0 │   66.0 │  
│   1425 │  2625 │     1441 │  547.5 │  550.0 │          │ 10班    │ 杭州市余杭中学 │ … │  111.5 │   79.5 │   82.5 │   82.5 │   79.0 │   81.0 │   82.0 │  
│   2213 │  1716 │     1495 │  531.5 │  570.5 │          │ 10班    │ 杭州市余杭中学 │ … │  104.0 │   75.0 │   93.0 │   90.5 │   86.5 │   63.0 │   70.0 │  
│   2504 │  1936 │     1529 │  526.5 │  564.5 │          │ 11班    │ 杭州市余杭中学 │ … │   78.5 │   85.0 │   81.5 │   96.0 │   62.0 │   77.5 │   85.0 │  
│   2165 │  1111 │     1606 │  532.5 │  589.0 │          │ 14班    │ 杭州市余杭中学 │ … │  125.5 │   84.5 │   90.5 │   79.0 │   63.5 │   71.0 │   63.0 │  
│   1948 │  1917 │     1700 │  537.0 │  565.0 │   xxx    │ 14班    │ 杭州市余杭中学 │ … │  105.5 │   81.0 │   87.0 │   78.0 │   78.5 │   63.5 │   76.0 │  
│   1829 │  1763 │     1717 │ 539.25 │  569.0 │          │ 14班    │ 杭州市余杭中学 │ … │  123.0 │   68.0 │   90.0 │   85.5 │  81.25 │   73.5 │   59.0 │  
│   3293 │  1774 │     1731 │  514.5 │  569.0 │          │ 12班    │ 杭州市余杭中学 │ … │   95.0 │   78.5 │   97.0 │   92.0 │   66.5 │   72.5 │   74.0 │  
│   1689 │  2291 │     1785 │  542.0 │  556.5 │          │ 11班    │ 杭州市余杭中学 │ … │  106.5 │   72.5 │   89.0 │   76.5 │   75.0 │   81.5 │   67.0 │  
│   1221 │  3101 │     1802 │  553.5 │  540.5 │          │ 8班     │ 杭州市余杭中学 │ … │  118.0 │   61.0 │   87.0 │   78.0 │   83.0 │   85.0 │   71.0 │  
│   2249 │  2385 │     1868 │  531.0 │  554.5 │          │ 13班    │ 杭州市余杭中学 │ … │  126.0 │   76.5 │   83.0 │   87.0 │   79.5 │   72.5 │   71.0 │  
│   3360 │  2439 │     1953 │  513.5 │  553.5 │          │ 10班    │ 杭州市余杭中学 │ … │   87.5 │   88.5 │   94.0 │   79.0 │   73.0 │   77.5 │   71.0 │  
│   1396 │  2507 │     2016 │  548.5 │  552.0 │          │ 13班    │ 杭州市余杭中学 │ … │  128.0 │   67.5 │   84.0 │   73.5 │   81.5 │   67.0 │   73.0 │  
│   1691 │  2809 │     2044 │  542.0 │  546.0 │          │ 11班    │ 杭州市余杭中学 │ … │  116.5 │   62.5 │   85.5 │   82.5 │   79.0 │   68.5 │   79.0 │  
│   3112 │  2634 │     2056 │  517.0 │  550.0 │          │ 8班     │ 杭州市余杭中学 │ … │   94.0 │   75.0 │   97.5 │   82.5 │   63.0 │   85.0 │   74.0 │  
│   2481 │  2671 │     2074 │  527.0 │  549.0 │          │ 14班    │ 杭州市余杭中学 │ … │   88.0 │   85.5 │   86.0 │   73.0 │   76.0 │   75.5 │   71.0 │  
├────────┴───────┴──────────┴────────┴────────┴──────────┴─────────┴────────────────┴───┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 20 rows                                                                                                                        22 columns (15 shown) │  
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
4、和前面说的文理排名几乎一样.  结果未偏科,  平时投入时间偏理.  文科成绩有较大提升空间.    
  
  
选课后的排名预估逻辑:     
- 假设选理科, 由于平时已经花了更多时间在理科, 容易被那些平时没花多少时间在理科, 但是理科成绩依旧很不错(文科排名远前理科排名, 假设相差500名)的同学超越, 这类学生理科升500名. 同时再假设对于文理相差小与100名的同学, 具备理科在现有成绩上升300名的潜力.     
- 假设选文科, 由于平时已经花了更多时间在理科, 容易超越平时花了很多时间在文科, 并且理科成绩比较差的偏文科生(文科排名远前于理科排名, 假设相差500名), 这类学生文科降500名. 同时再假设对于文理相差小与100名的同学,  
具备文科在现有成绩上升300名的潜力.     
  
根据这两个逻辑, 看一下选什么比较靠谱.    
  
5、假设选理科:     
  
```  
select * from (  
  select row_number() over (order by case when li_rn - wen_rn >= 500 then li_rn-500 when abs(li_rn - wen_rn) <= 100 then li_rn-300 else li_rn end) as li_rn1 , * from (  
    select * from (  
      select   
        row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) desc nulls last) as wen_rn,   
        row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) desc nulls last) as li_rn,   
        "总分排名",   
        coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) as wen,  
        coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) as li,  
        COLUMNS(* EXCLUDE ("总分排名", "准考证号", "自定义考号")) from st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1')   
    ) t  
  ) t  
) t  
where "学校"='杭州市余杭中学' order by li_rn1 limit 20;   
  
┌────────┬────────┬───────┬──────────┬────────┬────────┬─────────┬─────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│ li_rn1 │ wen_rn │ li_rn │ 总分排名 │  wen   │   li   │  姓名   │  班级   │ … │  数学  │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ int64  │ int64  │ int64 │  int32   │ double │ double │ varchar │ varchar │   │ double │ double │ double │ double │ double │ double │ double │ double │  
├────────┼────────┼───────┼──────────┼────────┼────────┼─────────┼─────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│   1008 │    698 │   944 │      814 │  570.5 │  595.0 │         │ 13班    │ … │   99.0 │  127.5 │   75.5 │   87.5 │   88.0 │   79.0 │   74.5 │   73.0 │  
│   1191 │   2165 │  1111 │     1606 │  532.5 │  589.0 │         │ 14班    │ … │  109.0 │  125.5 │   84.5 │   90.5 │   79.0 │   63.5 │   71.0 │   63.0 │  
│   1363 │   4034 │  1284 │     2481 │  504.5 │  583.0 │         │ 13班    │ … │  125.0 │  103.0 │   78.5 │   94.0 │   83.5 │   61.0 │   62.5 │   54.0 │  
│   1377 │    966 │  1303 │      969 │  561.0 │  582.0 │         │ 14班    │ … │  119.5 │  108.5 │   84.0 │   87.0 │   81.0 │   77.0 │   85.0 │   69.0 │  
│   1416 │   1899 │  1339 │     1424 │  538.0 │  581.0 │         │ 11班    │ … │   95.0 │  117.5 │   77.5 │   90.0 │   87.0 │   72.5 │   73.0 │   66.0 │  
│   1557 │   1829 │  1763 │     1717 │ 539.25 │  569.0 │         │ 14班    │ … │  102.0 │  123.0 │   68.0 │   90.0 │   85.5 │  81.25 │   73.5 │   59.0 │  
│   1729 │   1948 │  1917 │     1700 │  537.0 │  565.0 │   xxx   │ 14班    │ … │  108.5 │  105.5 │   81.0 │   87.0 │   78.0 │   78.5 │   63.5 │   76.0 │  
│   1778 │   4069 │  1672 │     2223 │  504.0 │  572.0 │         │ 11班    │ … │  107.0 │  102.5 │   89.0 │   85.0 │   89.0 │   49.5 │   66.5 │   79.0 │  
│   1819 │   2213 │  1716 │     1495 │  531.5 │  570.5 │         │ 10班    │ … │  106.0 │  104.0 │   75.0 │   93.0 │   90.5 │   86.5 │   63.0 │   70.0 │  
│   1854 │   1994 │  2050 │     1417 │  536.0 │  562.0 │         │ 11班    │ … │  100.5 │   97.5 │   76.0 │   89.5 │   91.5 │   73.0 │   80.0 │   78.0 │  
│   1883 │   3293 │  1774 │     1731 │  514.5 │  569.0 │         │ 12班    │ … │  101.0 │   95.0 │   78.5 │   97.0 │   92.0 │   66.5 │   72.5 │   74.0 │  
│   1899 │   1689 │  2291 │     1785 │  542.0 │  556.5 │         │ 11班    │ … │  103.5 │  106.5 │   72.5 │   89.0 │   76.5 │   75.0 │   81.5 │   67.0 │  
│   2018 │   4384 │  1911 │     2630 │ 500.25 │  565.5 │         │ 11班    │ … │  101.5 │  117.5 │   81.5 │   90.0 │   84.5 │  58.25 │   60.5 │   72.0 │  
│   2037 │   2504 │  1936 │     1529 │  526.5 │  564.5 │         │ 11班    │ … │  117.0 │   78.5 │   85.0 │   81.5 │   96.0 │   62.0 │   77.5 │   85.0 │  
│   2123 │   1396 │  2507 │     2016 │  548.5 │  552.0 │         │ 13班    │ … │   93.5 │  128.0 │   67.5 │   84.0 │   73.5 │   81.5 │   67.0 │   73.0 │  
│   2158 │   5325 │  2043 │     2765 │  489.5 │  562.5 │         │ 13班    │ … │   97.5 │  102.5 │   84.5 │   91.0 │   87.0 │   67.5 │   65.0 │   57.0 │  
│   2234 │   1425 │  2625 │     1441 │  547.5 │  550.0 │         │ 10班    │ … │   96.5 │  111.5 │   79.5 │   82.5 │   82.5 │   79.0 │   81.0 │   82.0 │  
│   2240 │   3834 │  2129 │     2829 │  507.5 │  560.5 │         │ 12班    │ … │  101.5 │  105.0 │   70.0 │   95.5 │   77.5 │   65.5 │   66.0 │   58.5 │  
│   2255 │   2810 │  2145 │     2352 │  521.5 │  560.0 │         │ 14班    │ … │  124.0 │   98.0 │   86.0 │   79.0 │   77.0 │   74.0 │   71.5 │   58.0 │  
│   2334 │   2092 │  2213 │     2135 │  534.0 │  558.5 │         │ 13班    │ … │   98.5 │  111.0 │   62.5 │   82.0 │   91.0 │   82.0 │   68.0 │   61.0 │  
├────────┴────────┴───────┴──────────┴────────┴────────┴─────────┴─────────┴───┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 20 rows                                                                                                                        23 columns (16 shown) │  
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
6、假设选文科:    
  
```  
select * from (  
  select row_number() over (order by case when li_rn - wen_rn >= 500 then wen_rn+500 when abs(li_rn - wen_rn) <= 100 then wen_rn-300 else wen_rn end) as wen_rn1 , * from (  
    select * from (  
      select   
        row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) desc nulls last) as wen_rn,   
        row_number() over (order by coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) desc nulls last) as li_rn,   
        "总分排名",   
        coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("政治",0)+coalesce("历史",0)+coalesce("地理",0) as wen,  
        coalesce("语文",0)+coalesce("数学",0)+coalesce("英语",0)+coalesce("物理",0)+coalesce("化学",0)+coalesce("生物",0) as li,  
        COLUMNS(* EXCLUDE ("总分排名", "准考证号", "自定义考号")) from st_read('/Users/digoal/Downloads/总分.xlsx', layer='Sheet1')   
    ) t  
  ) t  
) t  
where "学校"='杭州市余杭中学' order by wen_rn1 limit 20;   
  
┌─────────┬────────┬───────┬──────────┬────────┬────────┬──────────┬─────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│ wen_rn1 │ wen_rn │ li_rn │ 总分排名 │  wen   │   li   │   姓名   │  班级   │ … │  数学  │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│  int64  │ int64  │ int64 │  int32   │ double │ double │ varchar  │ varchar │   │ double │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼────────┼───────┼──────────┼────────┼────────┼──────────┼─────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│     591 │    698 │   944 │      814 │  570.5 │  595.0 │          │ 13班    │ … │   99.0 │  127.5 │   75.5 │   87.5 │   88.0 │   79.0 │   74.5 │   73.0 │  
│     803 │    966 │  1303 │      969 │  561.0 │  582.0 │          │ 14班    │ … │  119.5 │  108.5 │   84.0 │   87.0 │   81.0 │   77.0 │   85.0 │   69.0 │  
│    1358 │   1829 │  1763 │     1717 │ 539.25 │  569.0 │          │ 14班    │ … │  102.0 │  123.0 │   68.0 │   90.0 │   85.5 │  81.25 │   73.5 │   59.0 │  
│    1468 │   1948 │  1917 │     1700 │  537.0 │  565.0 │    xxx   │ 14班    │ … │  108.5 │  105.5 │   81.0 │   87.0 │   78.0 │   78.5 │   63.5 │   76.0 │  
│    1478 │   1155 │  2755 │     1190 │  555.0 │  547.0 │          │ 11班    │ … │   74.0 │  119.0 │   76.5 │   90.0 │   81.5 │   86.0 │   85.0 │   85.0 │  
│    1515 │   1994 │  2050 │     1417 │  536.0 │  562.0 │          │ 11班    │ … │  100.5 │   97.5 │   76.0 │   89.5 │   91.5 │   73.0 │   80.0 │   78.0 │  
│    1535 │   1221 │  3101 │     1802 │  553.5 │  540.5 │          │ 8班     │ … │   88.5 │  118.0 │   61.0 │   87.0 │   78.0 │   83.0 │   85.0 │   71.0 │  
│    1598 │   1794 │  2272 │     2352 │  540.0 │  557.0 │          │ 12班    │ … │   91.5 │  129.5 │   54.0 │   91.5 │   78.0 │   72.0 │   69.5 │   65.0 │  
│    1611 │   1309 │  3810 │     2528 │  551.0 │  527.0 │          │ 13班    │ … │  107.5 │  104.0 │   53.0 │   78.0 │   77.0 │   83.5 │   78.5 │   70.0 │  
│    1688 │   1396 │  2507 │     2016 │  548.5 │  552.0 │          │ 13班    │ … │   93.5 │  128.0 │   67.5 │   84.0 │   73.5 │   81.5 │   67.0 │   73.0 │  
│    1690 │   1397 │  5033 │     3316 │  548.5 │  507.5 │          │ 11班    │ … │   84.0 │  120.5 │   53.5 │   69.5 │   67.5 │   78.0 │   77.5 │   76.0 │  
│    1693 │   1899 │  1339 │     1424 │  538.0 │  581.0 │          │ 11班    │ … │   95.0 │  117.5 │   77.5 │   90.0 │   87.0 │   72.5 │   73.0 │   66.0 │  
│    1717 │   1425 │  2625 │     1441 │  547.5 │  550.0 │          │ 10班    │ … │   96.5 │  111.5 │   79.5 │   82.5 │   82.5 │   79.0 │   81.0 │   82.0 │  
│    1875 │   2092 │  2213 │     2135 │  534.0 │  558.5 │          │ 13班    │ … │   98.5 │  111.0 │   62.5 │   82.0 │   91.0 │   82.0 │   68.0 │   61.0 │  
│    1940 │   2165 │  1111 │     1606 │  532.5 │  589.0 │          │ 14班    │ … │  109.0 │  125.5 │   84.5 │   90.5 │   79.0 │   63.5 │   71.0 │   63.0 │  
│    1948 │   1669 │  5248 │     3316 │  542.5 │  505.0 │          │ 7班     │ … │   80.0 │  124.5 │   55.5 │   66.0 │   75.0 │   73.5 │   88.5 │   72.0 │  
│    1967 │   1689 │  2291 │     1785 │  542.0 │  556.5 │          │ 11班    │ … │  103.5 │  106.5 │   72.5 │   89.0 │   76.5 │   75.0 │   81.5 │   67.0 │  
│    1971 │   1691 │  2809 │     2044 │  542.0 │  546.0 │          │ 11班    │ … │   96.0 │  116.5 │   62.5 │   85.5 │   82.5 │   79.0 │   68.5 │   79.0 │  
│    1993 │   2213 │  1716 │     1495 │  531.5 │  570.5 │          │ 10班    │ … │  106.0 │  104.0 │   75.0 │   93.0 │   90.5 │   86.5 │   63.0 │   70.0 │  
│    2029 │   2249 │  2385 │     1868 │  531.0 │  554.5 │          │ 13班    │ … │   76.5 │  126.0 │   76.5 │   83.0 │   87.0 │   79.5 │   72.5 │   71.0 │  
├─────────┴────────┴───────┴──────────┴────────┴────────┴──────────┴─────────┴───┴────────┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 20 rows                                                                                                                          23 columns (16 shown) │  
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
实际排名采用文理赋分的方式进行排名, 以上方法未考虑赋分, 未考虑其他人的选择. 但是大致逻辑没毛病.   
   
其他建议阅读:
- [《德说-第215期, 和ChatGPT聊一聊, 高考如何选择专业? 大学如何修炼出师? 毕业如何终身成长?》](../202303/20230331_09.md)  
- [《德说-第227期, 致大学生的入学第一课, 如何从大一开始就为就业做正确的事情?》](../202305/20230513_01.md)  
- [《德说-第224期, 如何启发小孩的创新思维? 为什么以往中国本土理科诺贝尔奖偏少?》](../202304/20230421_01.md)  
- [《德说-第241期, 人生最重要的事9: 设立目标》](../202306/20230613_01.md)  
- [《德说-第173期, 人生最重要的事8: 成象能力》](../202211/20221116_03.md)  
- [《德说-第161期, 人生最重要的事7: 知行合一, 空谈误国》](../202210/20221021_01.md)  
- [《德说-第155期, 人生最重要的事6: 格局》](../202210/20221002_01.md)  
- [《德说-第154期, 人生最重要的事5: 生态思维和产品思维》](../202210/20221001_03.md)  
- [《德说-第145期, 人生最重要的事4: 刻意练习逻辑能力,储备命题 - 以OKR命题为例 - 充分必要》](../202209/20220917_01.md)  
- [《德说-第127期, 人生最重要的事1: 相信爱与奉献》](../202208/20220822_01.md)  
- [《德说-第126期, 人生最重要的事2: 定位-找回迷失在现象界的本我-完成生命的高维跃迁》](../202208/20220819_03.md)  
- [《德说-第100期, 人生最重要的事3: 建立公理体系和逻辑能力》](../202206/20220610_01.md)  
  
## 行头参数控制: OGR_XLSX_HEADERS
启动DuckDB SQL前, 设置环境变量来调整是否强制使用第一行作为列名.  
  
Set those options in an environment variable prior to executing the DuckDB SQL statement. The options include:  
  
https://gdal.org/user/configoptions.html#configoptions  
  
https://gdal.org/drivers/vector/xlsx.html   
  
  
```  
env OGR_XLSX_HEADERS=DISABLE ./duckdb  
  
D SELECT * FROM st_read('/root/总分.xlsx', layer='Sheet1') limit 10;    
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬─────────┬──────────┬───┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐  
│ Field1  │  Field2  │   Field3   │ Field4  │       Field5       │ Field6  │  Field7  │ … │ Field15 │ Field16 │ Field17 │ Field18 │ Field19 │ Field20 │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ varchar │ varchar  │   │ varchar │ varchar │ varchar │ varchar │ varchar │ varchar │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼─────────┼──────────┼───┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤  
│ 姓名    │ 准考证号 │ 自定义考号 │ 班级    │ 学校               │ 总分    │ 总分排名 │ … │ 物理    │ 化学    │ 生物    │ 政治    │ 历史    │ 地理    │  
│         │ 81268741 │ 0101250223 │ 2502班  │ 浙江省萧山中学     │ 937.5   │ 1        │ … │ 98      │ 99      │ 99      │ 84      │ 85.5    │ 94      │  
│         │ 80956567 │ 0801250903 │ 9班     │ 杭州市余杭高级中学 │ 934.5   │ 2        │ … │ 98      │ 96      │ 99      │ 85      │ 90      │ 73      │  
│         │ 81268761 │ 0101250243 │ 2502班  │ 浙江省萧山中学     │ 929.5   │ 3        │ … │ 98      │ 99.5    │ 100     │ 86      │ 86      │ 85      │  
│         │ 81267036 │ 0101250113 │ 2501班  │ 浙江省萧山中学     │ 928.5   │ 4        │ … │ 97      │ 90.5    │ 100     │ 83      │ 85      │ 80      │  
│         │ 81270552 │ 0101250549 │ 2505班  │ 浙江省萧山中学     │ 926     │ 5        │ … │ 96      │ 99      │ 94      │ 89      │ 78.5    │ 92      │  
│         │ 81268752 │ 0101250234 │ 2502班  │ 浙江省萧山中学     │ 925.5   │ 6        │ … │ 94.5    │ 100     │ 94      │ 85.5    │ 88.5    │ 86      │  
│         │ 80311834 │ 0501250129 │ 1班     │ 桐庐中学           │ 923     │ 7        │ … │ 99      │ 93      │ 93      │ 89      │ 92      │ 76      │  
│         │ 80958028 │ 0801250517 │ 5班     │ 杭州市余杭高级中学 │ 922.25  │ 8        │ … │ 97.5    │ 97      │ 97.5    │ 83.75   │ 87.5    │ 79      │  
│         │ 80958029 │ 0801251221 │ 12班    │ 杭州市余杭高级中学 │ 922.25  │ 8        │ … │ 80      │ 91      │ 92      │ 90.75   │ 87      │ 88      │  
├─────────┴──────────┴────────────┴─────────┴────────────────────┴─────────┴──────────┴───┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┤  
│ 10 rows                                                                                                                       20 columns (13 shown) │  
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
  
  
root@69a85f367c82:~# env OGR_XLSX_HEADERS=FORCE ./duckdb  
v0.8.1 6536a77232  
Enter ".help" for usage hints.  
Connected to a transient in-memory database.  
Use ".open FILENAME" to reopen on a persistent database.  
D install spatial;  
D load spatial;  
D SELECT * FROM st_read('/root/总分.xlsx', layer='Sheet1') limit 10;    
┌─────────┬──────────┬────────────┬─────────┬────────────────────┬────────┬──────────┬───┬────────┬────────┬────────┬────────┬────────┬────────┬────────┐  
│  姓名   │ 准考证号 │ 自定义考号 │  班级   │        学校        │  总分  │ 总分排名 │ … │  英语  │  物理  │  化学  │  生物  │  政治  │  历史  │  地理  │  
│ varchar │ varchar  │  varchar   │ varchar │      varchar       │ double │  int32   │   │ double │ double │ double │ double │ double │ double │ double │  
├─────────┼──────────┼────────────┼─────────┼────────────────────┼────────┼──────────┼───┼────────┼────────┼────────┼────────┼────────┼────────┼────────┤  
│        │ 81268741 │ 0101250223 │ 2502班  │ 浙江省萧山中学     │  937.5 │        1 │ … │  132.5 │   98.0 │   99.0 │   99.0 │   84.0 │   85.5 │   94.0 │  
│        │ 80956567 │ 0801250903 │ 9班     │ 杭州市余杭高级中学 │  934.5 │        2 │ … │  138.5 │   98.0 │   96.0 │   99.0 │   85.0 │   90.0 │   73.0 │  
│        │ 81268761 │ 0101250243 │ 2502班  │ 浙江省萧山中学     │  929.5 │        3 │ … │  138.5 │   98.0 │   99.5 │  100.0 │   86.0 │   86.0 │   85.0 │  
│        │ 81267036 │ 0101250113 │ 2501班  │ 浙江省萧山中学     │  928.5 │        4 │ … │  139.5 │   97.0 │   90.5 │  100.0 │   83.0 │   85.0 │   80.0 │  
│        │ 81270552 │ 0101250549 │ 2505班  │ 浙江省萧山中学     │  926.0 │        5 │ … │  136.5 │   96.0 │   99.0 │   94.0 │   89.0 │   78.5 │   92.0 │  
│        │ 81268752 │ 0101250234 │ 2502班  │ 浙江省萧山中学     │  925.5 │        6 │ … │  132.0 │   94.5 │  100.0 │   94.0 │   85.5 │   88.5 │   86.0 │  
│        │ 80311834 │ 0501250129 │ 1班     │ 桐庐中学           │  923.0 │        7 │ … │  124.0 │   99.0 │   93.0 │   93.0 │   89.0 │   92.0 │   76.0 │  
│        │ 80958028 │ 0801250517 │ 5班     │ 杭州市余杭高级中学 │ 922.25 │        8 │ … │  138.0 │   97.5 │   97.0 │   97.5 │  83.75 │   87.5 │   79.0 │  
│        │ 80958029 │ 0801251221 │ 12班    │ 杭州市余杭高级中学 │ 922.25 │        8 │ … │  140.5 │   80.0 │   91.0 │   92.0 │  90.75 │   87.0 │   88.0 │  
│        │ 81270528 │ 0101250525 │ 2505班  │ 浙江省萧山中学     │ 922.25 │        8 │ … │  130.0 │   98.0 │   98.5 │   96.5 │  85.75 │   90.5 │   87.0 │  
├─────────┴──────────┴────────────┴─────────┴────────────────────┴────────┴──────────┴───┴────────┴────────┴────────┴────────┴────────┴────────┴────────┤  
│ 10 rows                                                                                                                         20 columns (14 shown) │  
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  
```  
  
  
    
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
